{% extends "base.html" %}

{% block title %}Create Quiz (Simple) - UniTest{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Create Quiz (Simple)</h2>
  <p class="text-muted">Enter a topic and number of MCQs. A shareable code will be generated.</p>

  <div class="row">
    <!-- Left Half: Create Quiz Form -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">Optional Title</label>
          <input name="title" class="form-control" placeholder="e.g., Algebra Basics Quiz">
        </div>
        <div class="mb-3">
          <label class="form-label">Topic (optional if uploading PDFs)</label>
          <input name="topic" class="form-control" placeholder="e.g., Algebra">
          <div class="form-text">
            <strong>OR</strong> upload PDF file(s) below to generate questions from PDF content
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Notes PDF File(s) (optional)</label>
          <input type="file" name="notes_pdf" accept="application/pdf" class="form-control" multiple id="notes_pdf_input">
          <div class="form-text">
            Upload one or multiple PDFs to generate questions from PDF content. Supports both text-based and scanned/image-based PDFs (OCR enabled).
            <br><strong>Maximum file size: 4.5MB per PDF</strong> (for larger files, split into multiple PDFs).
          </div>
          <div id="file_size_warning" class="alert alert-warning mt-2" style="display:none;"></div>
        </div>
        
        <script>
          document.getElementById('notes_pdf_input').addEventListener('change', function(e) {
            const files = e.target.files;
            const maxSize = 4.5 * 1024 * 1024; // 4.5MB in bytes
            const warningDiv = document.getElementById('file_size_warning');
            let hasLargeFile = false;
            let largeFiles = [];
            
            for (let i = 0; i < files.length; i++) {
              if (files[i].size > maxSize) {
                hasLargeFile = true;
                const sizeMB = (files[i].size / (1024 * 1024)).toFixed(2);
                largeFiles.push(`${files[i].name} (${sizeMB}MB)`);
              }
            }
            
            if (hasLargeFile) {
              warningDiv.innerHTML = '<strong>Warning:</strong> The following file(s) exceed 4.5MB limit: ' + largeFiles.join(', ') + '. Please split into smaller files or compress the PDF.';
              warningDiv.style.display = 'block';
            } else {
              warningDiv.style.display = 'none';
            }
          });
        </script>
        <div class="mb-3">
          <label class="form-label">Question Type</label>
          <select class="form-select" name="question_type" id="question_type" required>
            <option value="mcq" selected>Multiple Choice (MCQ)</option>
            <option value="subjective">Subjective</option>
            <option value="coding">Coding Problems</option>
          </select>
          <div class="form-text">Select coding problems to create programming questions with test cases.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Difficulty</label>
          <select class="form-select" name="difficulty">
            <option value="beginner" selected>Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Number of Questions</label>
          <input name="count" type="number" min="1" max="20" class="form-control" value="5" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Marks per Question</label>
          <input name="marks" type="number" min="1" max="100" class="form-control" value="1">
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (minutes, optional)</label>
          <input name="duration" type="number" min="1" max="300" class="form-control" placeholder="e.g., 30">
        </div>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Cancel</a>
              <button class="btn btn-primary" type="submit">Preview Questions</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right Half: Extract Questions from PDFs -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-file-pdf me-2"></i>Extract Questions from PDFs
          </h5>
        </div>
        <div class="card-body">
          <form id="extractQuestionsForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label fw-bold">Select PDF Files:</label>
              <input type="file" name="pdf_files" accept="application/pdf" class="form-control" multiple id="extract_pdf_files">
              <div class="form-text">Select one or multiple PDF files to extract questions from.</div>
              <div id="extract_file_list" class="mt-2"></div>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Enter Keywords/Sentence:</label>
              <input type="text" name="keywords" class="form-control" id="extract_keywords" 
                     placeholder="e.g., 'machine learning algorithms', 'data structures', 'photosynthesis process'">
              <div class="form-text text-muted">
                Example: 'machine learning algorithms', 'data structures', 'photosynthesis process'
              </div>
            </div>
            
            <button type="button" class="btn btn-success w-100" id="extractQuestionsBtn">
              <i class="fas fa-search me-2"></i>Extract Questions
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // File selection display
  document.getElementById('extract_pdf_files').addEventListener('change', function(e) {
    const files = e.target.files;
    const fileListDiv = document.getElementById('extract_file_list');
    
    if (files.length > 0) {
      let fileList = '<div class="alert alert-info"><strong>Selected Files:</strong><ul class="mb-0 mt-2">';
      for (let i = 0; i < files.length; i++) {
        const sizeMB = (files[i].size / (1024 * 1024)).toFixed(2);
        fileList += `<li>${files[i].name} (${sizeMB} MB)</li>`;
      }
      fileList += '</ul></div>';
      fileListDiv.innerHTML = fileList;
    } else {
      fileListDiv.innerHTML = '';
    }
  });

  // Extract Questions button handler
  document.getElementById('extractQuestionsBtn').addEventListener('click', function() {
    const pdfFiles = document.getElementById('extract_pdf_files').files;
    const keywords = document.getElementById('extract_keywords').value.trim();
    
    if (pdfFiles.length === 0) {
      alert('Please select at least one PDF file.');
      return;
    }
    
    if (!keywords) {
      alert('Please enter keywords or a sentence to extract questions.');
      return;
    }
    
    // Create form data
    const formData = new FormData();
    for (let i = 0; i < pdfFiles.length; i++) {
      formData.append('pdf_files', pdfFiles[i]);
    }
    formData.append('keywords', keywords);
    
    // Open in new window
    const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
    newWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Extracting Questions...</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0;
            background: #f5f5f5;
          }
          .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </head>
      <body>
        <div class="loading">
          <div class="spinner"></div>
          <h3>Extracting Questions from PDFs...</h3>
          <p>Please wait while we process your PDFs and extract questions based on your keywords.</p>
        </div>
      </body>
      </html>
    `);
    
    // Submit form to extract endpoint
    fetch('/teacher/quiz/extract_questions', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        newWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Extracted Questions</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              body { padding: 20px; background: #f5f5f5; }
              .question-card { margin-bottom: 20px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h2 class="mb-4">Extracted Questions</h2>
              <div class="alert alert-success">Successfully extracted ${data.questions.length} question(s) from PDF(s)</div>
              ${data.questions.map((q, idx) => `
                <div class="card question-card">
                  <div class="card-body">
                    <h5>Question ${idx + 1}</h5>
                    <p><strong>Question:</strong> ${q.question}</p>
                    ${q.options ? `<p><strong>Options:</strong> ${q.options.join(', ')}</p>` : ''}
                    <p><strong>Answer:</strong> ${q.answer}</p>
                  </div>
                </div>
              `).join('')}
              <button class="btn btn-primary" onclick="window.close()">Close</button>
            </div>
          </body>
          </html>
        `);
      } else {
        newWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Error</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body>
            <div class="container mt-5">
              <div class="alert alert-danger">
                <h4>Error</h4>
                <p>${data.error || 'Failed to extract questions. Please try again.'}</p>
              </div>
              <button class="btn btn-secondary" onclick="window.close()">Close</button>
            </div>
          </body>
          </html>
        `);
      }
    })
    .catch(error => {
      newWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Error</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        </head>
        <body>
          <div class="container mt-5">
            <div class="alert alert-danger">
              <h4>Error</h4>
              <p>An error occurred: ${error.message}</p>
            </div>
            <button class="btn btn-secondary" onclick="window.close()">Close</button>
          </div>
        </body>
        </html>
      `);
    });
  });
</script>
{% endblock %}


