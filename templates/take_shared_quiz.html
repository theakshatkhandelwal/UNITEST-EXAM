{% extends "base.html" %}

{% block title %}Take Quiz - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{{ quiz.title }}</h2>
    <span class="badge bg-secondary">Code: {{ quiz.code }}</span>
  </div>

  {% if quiz.duration_minutes %}
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
      <i class="fas fa-hourglass-half me-2"></i>Time limit: {{ quiz.duration_minutes }} minutes
    </div>
    <div><strong id="countdown"></strong></div>
  </div>
  {% endif %}

  <!-- Fullscreen Gate - Always Visible -->
  <div id="fs-gate"
    style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);color:#fff;z-index:99999;display:flex;align-items:center;justify-content:center;">
    <div style="text-align:center;max-width:520px;padding:16px;position:relative;z-index:100000;">
      <h3 class="mb-3">üîí Enter Fullscreen to Start Quiz</h3>
      <p class="mb-3">You must be in fullscreen mode to take this test.</p>
      <p class="mb-3">Exiting fullscreen will end your session.</p>
      <button id="startQuizBtn" class="btn btn-primary btn-lg"
        style="cursor:pointer;pointer-events:auto;position:relative;z-index:100001;min-width:200px;padding:12px 24px;font-size:1.1rem;">
        Enter Fullscreen & Start
      </button>
    </div>
  </div>

  <!-- Top Navigation Bar with Question Numbers and Submit Button -->
  <div id="quiz-nav-bar"
    style="display:none; background: #252526; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; position: sticky; top: 0; z-index: 100;">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2 align-items-center">
        <span style="color: #d4d4d4; margin-right: 10px;">Questions:</span>
        {% for q in questions %}
        <button type="button" class="question-nav-btn btn btn-sm" data-question-index="{{ loop.index0 }}"
          style="min-width: 40px; background: #3e3e42; color: #d4d4d4; border: 1px solid #555;">
          {{ loop.index }}
        </button>
        {% endfor %}
      </div>
      <div>
        <span id="current-question-indicator" style="color: #d4d4d4; margin-right: 15px;">Question 1 of {{
          questions|length }}</span>
        <button type="button" class="btn btn-success" id="finalSubmitBtn" style="background: #26a69a; border: none;">
          <i class="fas fa-check"></i> Submit Quiz
        </button>
      </div>
    </div>
  </div>

  <form id="quizForm" method="POST" action="{{ url_for('submit_shared_quiz', code=quiz.code) }}" style="display:none;">
    <input type="hidden" name="fullscreen_exit" id="fullscreen_exit_flag" value="false">
    <input type="hidden" name="alt_tab_flag" id="alt_tab_flag" value="false">
    <input type="hidden" name="win_shift_s_flag" id="win_shift_s_flag" value="false">
    <input type="hidden" name="win_prtscn_flag" id="win_prtscn_flag" value="false">
    <input type="hidden" name="prtscn_flag" id="prtscn_flag" value="false">
    <input type="hidden" name="tab_switch_flag" id="tab_switch_flag" value="false">

    <!-- New Proctoring Metrics -->
    <input type="hidden" name="full_screen_exit_count" id="inp_full_screen_exit_count" value="0">
    <input type="hidden" name="tab_switch_count" id="inp_tab_switch_count" value="0">
    <input type="hidden" name="page_unfocused_count" id="inp_page_unfocused_count" value="0">
    <input type="hidden" name="total_breaches" id="inp_total_breaches" value="0">

    <!-- Capture elements (hidden) -->
    <video id="proctorWebcam" style="display:none;" autoplay playsinline></video>
    <video id="proctorScreen" style="display:none;" autoplay playsinline></video>
    <canvas id="proctorCanvas" style="display:none;"></canvas>

    <!-- Single Question Container -->
    <div id="question-container">
      {% for q in questions %}
      <div class="question-wrapper mb-4" data-question-index="{{ loop.index0 }}"
        style="display: {% if loop.index0 == 0 %}block{% else %}none{% endif %};">
        <div class="card" style="background: #1e1e1e; border: 1px solid #3e3e42;">
          <div class="card-body">
            {% if q.qtype != 'coding' %}
            <div class="mb-3">
              <h5 class="fw-bold" style="color: #fff;">Q{{ loop.index }}. {{ q.question }}</h5>
            </div>
            {% endif %}

            {% if q.qtype == 'mcq' %}
            {% for opt in q.options %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="q_{{ q.id }}" value="{{ opt }}"
                id="q{{ q.id }}_{{ loop.index }}" data-question-id="{{ q.id }}">
              <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}" style="color: #d4d4d4;">{{ opt
                }}</label>
            </div>
            {% endfor %}
            {% elif q.qtype == 'coding' %}
            <div class="coding-question-container"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
              <!-- Left Panel: Problem Description -->
              <div class="problem-panel"
                style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-y: auto; max-height: 600px;">
                <div style="margin-bottom: 20px;">
                  <h4 style="color: #fff; margin-bottom: 10px;">Q{{ loop.index }}. {{ q.question }}</h4>
                  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <span class="badge" style="background: #26a69a; padding: 4px 12px; border-radius: 4px;">Easy</span>
                    <span class="badge" style="background: #555; padding: 4px 12px; border-radius: 4px;">Topics</span>
                  </div>
                </div>

                {% if q.sample_input and q.sample_output %}
                <div style="margin-bottom: 20px;">
                  <h5 style="color: #fff; margin-bottom: 10px;">Example:</h5>
                  <div style="background: #252526; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4ec9b0;">Input:</strong>
                      <pre
                        style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin: 5px 0; color: #ce9178; overflow-x: auto;"><code>{{ q.sample_input }}</code></pre>
                    </div>
                    <div>
                      <strong style="color: #4ec9b0;">Output:</strong>
                      <pre
                        style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin: 5px 0; color: #ce9178; overflow-x: auto;"><code>{{ q.sample_output }}</code></pre>
                    </div>
                  </div>
                </div>
                {% endif %}

                <div style="margin-bottom: 20px;">
                  <h5 style="color: #fff; margin-bottom: 10px;">Constraints:</h5>
                  <ul style="color: #d4d4d4; padding-left: 20px;">
                    <li>Time limit: {{ q.time_limit_seconds }} seconds</li>
                    <li>Memory limit: {{ q.memory_limit_mb }} MB</li>
                    <li>Allowed languages: {{ q.language_constraints|join(', ')|upper }}</li>
                  </ul>
                </div>

                <div style="color: #858585; font-size: 0.9em;">
                  <strong>Marks:</strong> {{ q.marks }}
                </div>
              </div>

              <!-- Right Panel: Code Editor -->
              <div class="code-panel"
                style="display: flex; flex-direction: column; background: #1e1e1e; border-radius: 8px; overflow: hidden;">
                <!-- Header with Language Selector -->
                <div
                  style="background: #252526; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #3e3e42;">
                  <div style="display: flex; align-items: center; gap: 15px;">
                    <select class="form-select language-select" id="language_{{ q.id }}" name="language_{{ q.id }}"
                      style="background: #1e1e1e; color: #d4d4d4; border: 1px solid #3e3e42; padding: 5px 10px; border-radius: 4px; max-width: 150px; font-size: 14px;">
                      {% for lang in q.language_constraints %}
                      <option value="{{ lang }}" {% if loop.index==1 %}selected{% endif %}
                        style="background: #1e1e1e; color: #d4d4d4;">{{ lang|upper }}</option>
                      {% endfor %}
                    </select>
                    <span style="color: #858585; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                      <i class="fas fa-keyboard"></i>
                      <span>Ctrl+Enter to run</span>
                    </span>
                  </div>
                  <div>
                    <button type="button" class="btn btn-sm test-code-btn run-code-btn" data-question-id="{{ q.id }}"
                      data-time-limit="{{ q.time_limit_seconds }}" data-memory-limit="{{ q.memory_limit_mb }}"
                      style="background: #0078d4; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px; transition: all 0.2s;"
                      title="Run code (Ctrl+Enter)" onmouseover="this.style.background='#0066b3'"
                      onmouseout="this.style.background='#0078d4'">
                      <i class="fas fa-play"></i> Run
                    </button>
                    <button type="button" class="btn btn-sm reset-code-btn" data-question-id="{{ q.id }}"
                      style="background: #3e3e42; color: #d4d4d4; border: 1px solid #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                      title="Reset code to starter template" onmouseover="this.style.background='#4e4e52'"
                      onmouseout="this.style.background='#3e3e42'">
                      Reset
                    </button>
                  </div>
                </div>

                <!-- Code Editor -->
                <div style="flex: 1; position: relative; min-height: 400px;">
                  {% set default_lang = q.language_constraints[0] if q.language_constraints else 'python' %}
                  {% set starter = q.starter_code[default_lang] if q.starter_code and default_lang in q.starter_code
                  else '# Write your code here\n' %}
                  <textarea class="form-control code-editor" name="code_{{ q.id }}" id="code_{{ q.id }}"
                    style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;">{{ starter }}</textarea>
                  <div id="codeeditor_{{ q.id }}"
                    style="height: 100%; min-height: 400px; position: relative; z-index: 1; pointer-events: auto;">
                  </div>
                </div>

                <!-- Test Results Panel -->
                <div id="test_results_{{ q.id }}"
                  style="background: #252526; padding: 15px; border-top: 1px solid #3e3e42; min-height: 100px; max-height: 200px; overflow-y: auto; display: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #fff;">Test Results</strong>
                    <span class="test-result" id="test_result_{{ q.id }}" style="color: #4ec9b0;"></span>
                  </div>
                  <div id="test_details_{{ q.id }}"></div>
                </div>
              </div>
            </div>
            {% else %}
            <textarea class="form-control answer-textarea" name="q_{{ q.id }}" rows="5" placeholder="Your answer..."
              data-question-id="{{ q.id }}"
              style="background: #252526; color: #d4d4d4; border: 1px solid #555;"></textarea>
            <small class="text-muted" style="color: #858585;">Marks: {{ q.marks }}</small>
            {% endif %}
          </div>
        </div>

        <!-- Navigation Buttons for Each Question -->
        <div class="d-flex justify-content-between align-items-center mt-3" style="padding: 0 15px;">
          <div>
            {% if loop.index0 > 0 %}
            <button type="button" class="btn btn-outline-secondary prev-question-btn"
              data-question-index="{{ loop.index0 }}">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            {% endif %}
          </div>
          <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-danger">
              <i class="fas fa-times"></i> Cancel
            </a>
            {% if loop.index < questions|length %} <button type="button" class="btn btn-primary next-question-btn"
              data-question-index="{{ loop.index0 }}">
              Save & Next <i class="fas fa-arrow-right"></i>
              </button>
              {% else %}
              <button type="button" class="btn btn-primary next-question-btn" data-question-index="{{ loop.index0 }}"
                style="display: none;">
                Save & Next <i class="fas fa-arrow-right"></i>
              </button>
              {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>
</div>

<script>
  // Inline JavaScript - runs immediately
  let timerInterval = null;
  let quizStarted = false;

  function startQuiz() {
    console.log('Starting quiz...');

    // Try to enter fullscreen
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen().then(() => {
        console.log('Entered fullscreen');
        showQuiz();
      }).catch(err => {
        console.error('Fullscreen failed:', err);
        alert('Could not enter fullscreen. Please allow fullscreen and try again.');
      });
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
      showQuiz();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
      showQuiz();
    } else {
      console.log('No fullscreen support');
      showQuiz();
    }
  }

  // Ensure button is clickable - attach event listener
  function attachStartButtonListener() {
    const startBtn = document.getElementById('startQuizBtn');
    if (startBtn) {
      // Remove any existing listeners and add fresh one
      const newBtn = startBtn.cloneNode(true);
      startBtn.parentNode.replaceChild(newBtn, startBtn);

      newBtn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Start button clicked');
        startQuiz();
        return false;
      });

      // Also ensure it's visible and clickable
      newBtn.style.pointerEvents = 'auto';
      newBtn.style.cursor = 'pointer';
      newBtn.style.zIndex = '100001';
      newBtn.style.position = 'relative';

      console.log('Start button listener attached');
    } else {
      console.warn('Start button not found');
    }
  }

  // Try immediately (in case DOM is already loaded)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachStartButtonListener);
  } else {
    // DOM is already loaded
    attachStartButtonListener();
  }

  function showQuiz() {
    quizStarted = true;
    // Clear warnings when quiz starts (fresh start for each quiz)
    violationWarnings = {};
    try {
      localStorage.removeItem(WARNING_KEY);
    } catch (e) {
      console.warn('Could not clear warnings:', e);
    }

    document.getElementById('quizForm').style.display = '';
    document.getElementById('quiz-nav-bar').style.display = '';
    document.getElementById('fs-gate').remove();
    startTimer();

    // Initialize Proctoring
    initProctoring();

    // Initialize first question after a short delay to ensure DOM is ready
    setTimeout(function () {
      if (typeof window.updateQuestionIndicator === 'function') {
        window.updateQuestionIndicator(0);
        window.updateNavigationButtons(0);
      }
    }, 100);
  }

  function startTimer() {
    const minutes = {{ quiz.duration_minutes or 'null' }
  };
  if (!minutes) return;

  console.log('Starting timer for', minutes, 'minutes');
  const endTime = Date.now() + (minutes * 60 * 1000);
  const countdownEl = document.getElementById('countdown');

  timerInterval = setInterval(() => {
    const remaining = endTime - Date.now();
    if (remaining <= 0) {
      console.log('Time up! Auto-submitting');
      clearInterval(timerInterval);
      // Set flag to prevent fullscreen exit handler from logging out
      window.isSubmittingQuiz = true;
      // Save all answers before auto-submit
      if (window.codeMirrorEditors) {
        Object.keys(window.codeMirrorEditors).forEach(questionId => {
          const editor = window.codeMirrorEditors[questionId];
          const textarea = document.getElementById('code_' + questionId);
          if (editor && textarea) {
            textarea.value = editor.getValue();
          }
        });
      }
      document.getElementById('quizForm').submit();
      return;
    }

    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    if (countdownEl) {
      countdownEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }, 1000);
  }

  // Flag to track intentional submission (prevents logout on fullscreen exit during confirmation dialog)
  window.isSubmittingQuiz = false;

  function exitQuiz() {
    if (window.isSubmittingQuiz) return;

    const flags = {
      fullscreen_exit: true,
      alt_tab: document.getElementById('alt_tab_flag').value === 'true',
      tab_switch: document.getElementById('tab_switch_flag').value === 'true'
    };

    const answers = {};
    document.querySelectorAll('[data-question-id]').forEach(block => {
      const qid = block.getAttribute('data-question-id');
      const radio = block.querySelector('input[type="radio"]:checked');
      const textarea = block.querySelector('textarea');
      answers['q_' + qid] = radio ? radio.value : (textarea ? textarea.value : '');
    });
    answers['violation_flags'] = flags;

    try {
      const blob = new Blob([JSON.stringify(answers)], { type: 'application/json' });
      const submitUrl = "{{ url_for('auto_submit_partial', code=quiz.code) }}";
      navigator.sendBeacon(submitUrl, blob);
    } catch (e) {
      console.error('Failed to send answers:', e);
    }

    window.location.href = "{{ url_for('student_dashboard') }}";
  }

  // --- New Proctoring System ---
  const proctorConfig = {
    submissionId: parseInt("{{ submission.id if submission else 0 }}"),
    snapshotInterval: 120000,
    heartbeatInterval: 30000,
    snapUrl: "/proctor/snapshot/",
    heartbeatUrl: "/proctor/heartbeat/"
  };

  let proctorState = {
    full_screen_exit_count: 0,
    tab_switch_count: 0,
    total_breaches: 0
  };

  const WARNING_KEY = 'quiz_violation_warnings';
  let violationWarnings = {};

  // Load warnings from localStorage
  try {
    const stored = localStorage.getItem(WARNING_KEY);
    if (stored) {
      violationWarnings = JSON.parse(stored);
    }
  } catch (e) {
    console.warn('Could not load warnings from localStorage:', e);
  }

  let proctoringStartedAt = 0;
  async function initProctoring() {
    if (!proctorConfig.submissionId) return;

    try {
      // Request Webcam only (Screen share causes focus loss and exits fullscreen)
      const webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
      document.getElementById('proctorWebcam').srcObject = webcamStream;

      // Start Loops
      setInterval(() => takeSnapshot('webcam'), proctorConfig.snapshotInterval);
      setInterval(sendHeartbeat, proctorConfig.heartbeatInterval);

      proctoringStartedAt = Date.now();
      console.log("Proctoring initialized");
    } catch (e) {
      console.error("Proctoring initialization failed:", e);
      // Don't alert if quiz already started, just log
    }
  }

  function takeSnapshot(type) {
    const video = document.getElementById(type === 'webcam' ? 'proctorWebcam' : 'proctorScreen');
    if (!video || !video.srcObject) return;

    const canvas = document.getElementById('proctorCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL('image/jpeg', 0.7);
    const breaches = checkCurrentBreaches();

    fetch(proctorConfig.snapUrl + proctorConfig.submissionId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image: imageData,
        type: type,
        breaches: breaches,
        is_red_flag: breaches.length > 0
      })
    });
  }

  function checkCurrentBreaches() {
    let breaches = [];
    if (!document.fullscreenElement) breaches.push("NOT_FULLSCREEN");
    if (document.hidden) breaches.push("TAB_HIDDEN");
    // Add more real-time checks if possible
    return breaches;
  }

  function sendHeartbeat() {
    if (!proctorConfig.submissionId) return;

    // Update hidden inputs for final submission fallback
    document.getElementById('inp_full_screen_exit_count').value = proctorState.full_screen_exit_count;
    document.getElementById('inp_tab_switch_count').value = proctorState.tab_switch_count;
    document.getElementById('inp_page_unfocused_count').value = proctorState.page_unfocused_count;
    document.getElementById('inp_total_breaches').value = proctorState.total_breaches;

    fetch(proctorConfig.heartbeatUrl + proctorConfig.submissionId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(proctorState)
    });
  }

  function showWarning(violationType, message) {
    proctorState.total_breaches++;

    if (violationWarnings[violationType]) {
      console.log(`‚ö†Ô∏è Second ${violationType} violation - flagging`);
      return true;
    } else {
      violationWarnings[violationType] = true;
      try {
        localStorage.setItem(WARNING_KEY, JSON.stringify(violationWarnings));
      } catch (e) {
        console.warn('Could not save warning to localStorage:', e);
      }

      const warningModal = document.createElement('div');
      warningModal.id = 'warningModal_' + Date.now();
      warningModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:999999;display:flex;align-items:center;justify-content:center;';
      warningModal.innerHTML = `
      <div style="background:#1e1e1e;padding:30px;border-radius:10px;max-width:500px;border:2px solid #f48771;">
        <h3 style="color:#f48771;margin-bottom:15px;">‚ö†Ô∏è Warning</h3>
        <p style="color:#d4d4d4;margin-bottom:20px;font-size:16px;">${message}</p>
        <p style="color:#858585;margin-bottom:20px;font-size:14px;">This is your first warning. If you do this again, your quiz will be automatically submitted and flagged.</p>
        <button onclick="this.closest('#${warningModal.id}').remove()" style="background:#0078d4;color:white;border:none;padding:10px 30px;border-radius:5px;cursor:pointer;font-size:16px;width:100%;">I Understand</button>
      </div>
    `;
      document.body.appendChild(warningModal);
      return false;
    }
  }

  // Enhanced Event Listeners
  document.addEventListener('visibilitychange', function () {
    if (!quizStarted) return;
    if (document.hidden) {
      proctorState.tab_switch_count++;
      const shouldFlag = showWarning('tab_switch', 'You switched tabs or minimized the window.');
      if (shouldFlag) {
        document.getElementById('tab_switch_flag').value = 'true';
        exitQuiz();
      }
    }
  });

  window.addEventListener('blur', function () {
    if (!quizStarted) return;
    proctorState.page_unfocused_count++;
    const shouldFlag = showWarning('window_blur', 'You switched to another window.');
    if (shouldFlag) {
      document.getElementById('tab_switch_flag').value = 'true';
      exitQuiz();
    }
  });

  document.addEventListener('keydown', function (e) {
    const activeElement = document.activeElement;
    const isInput = activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT' || activeElement.closest('.CodeMirror'));

    if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'a' || e.key === 'v')) {
      if (!isInput) e.preventDefault();
      return;
    }

    if (!quizStarted) return;

    // Alt+Tab
    if (e.altKey && (e.key === 'Tab' || e.keyCode === 9)) {
      e.preventDefault();
      proctorState.tab_switch_count++;
      proctorState.illegal_key_combination_detected = true;
      const shouldFlag = showWarning('alt_tab', 'Alt+Tab shortcut detected.');
      if (shouldFlag) exitQuiz();
      return false;
    }

    // Snipping Tool / Screenshot
    const isWinKey = e.metaKey || (e.key && e.key.toLowerCase() === 'meta');
    if (isWinKey && e.shiftKey && (e.key && e.key.toLowerCase() === 's' || e.keyCode === 83)) {
      e.preventDefault();
      proctorState.illegal_key_combination_detected = true;
      const shouldFlag = showWarning('screenshot', 'Screenshot shortcut detected.');
      if (shouldFlag) exitQuiz();
      return false;
    }
    // DevTools (Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C)
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
      console.log('‚ö†Ô∏è Developer Tools shortcut detected');
      e.preventDefault();
      return false;
    }

    // Detect F12 (Developer Tools)
    if (e.key === 'F12' || e.keyCode === 123) {
      console.log('‚ö†Ô∏è F12 (Developer Tools) detected');
      e.preventDefault();
      return false;
    }
  });

  document.addEventListener('fullscreenchange', function () {
    // Only trigger if quiz has been running for at least 3 seconds (grace period)
    if (!document.fullscreenElement && quizStarted && (Date.now() - proctoringStartedAt > 3000)) {
      proctorState.full_screen_exit_count++;
      exitQuiz();
    }
  });

  // Disable text selection on body (but CSS allows it in code editors)
  document.body.style.userSelect = 'none';
  document.body.style.webkitUserSelect = 'none';
  document.body.style.mozUserSelect = 'none';
  document.body.style.msUserSelect = 'none';

  // Re-enable text selection for code editors after they're initialized
  setTimeout(function () {
    document.querySelectorAll('.CodeMirror, .CodeMirror *, textarea, .code-editor').forEach(function (el) {
      el.style.userSelect = 'text';
      el.style.webkitUserSelect = 'text';
      el.style.pointerEvents = 'auto';
    });
  }, 500);

  // Handle coding questions
  document.addEventListener('DOMContentLoaded', function () {
    // Load test cases for each coding question from the page
    const codingQuestions = {{ questions | tojson
  }};


  // Store test cases in a map
  const testCasesMap = {};
  codingQuestions.forEach(q => {
    if (q.qtype === 'coding') {
      testCasesMap[q.id] = q.test_cases || [];
    }
  });

  // Initialize CodeMirror editors for all coding questions
  window.codeMirrorEditors = {};
  const languageModes = {
    'python': 'python',
    'java': 'text/x-java',
    'cpp': 'text/x-c++src',
    'c': 'text/x-csrc',
    'javascript': 'javascript'
  };

  codingQuestions.forEach(q => {
    if (q.qtype === 'coding') {
      const questionId = q.id;
      const textarea = document.getElementById('code_' + questionId);
      const editorDiv = document.getElementById('codeeditor_' + questionId);
      const languageSelect = document.getElementById('language_' + questionId);

      if (textarea && editorDiv) {
        // Get initial language
        const initialLang = languageSelect ? languageSelect.value : 'python';

        // Parse starter_code if it's a JSON string
        let starterCodeObj = q.starter_code;
        if (typeof starterCodeObj === 'string') {
          try {
            starterCodeObj = JSON.parse(starterCodeObj);
          } catch (e) {
            console.warn('Failed to parse starter_code JSON:', e);
            starterCodeObj = {};
          }
        }

        // Get initial code from textarea or starter_code
        let initialCode = textarea.value;
        if (!initialCode || initialCode.trim() === '') {
          if (starterCodeObj && starterCodeObj[initialLang]) {
            initialCode = starterCodeObj[initialLang];
          } else if (starterCodeObj && Object.keys(starterCodeObj).length > 0) {
            // Use first available language's code
            const firstLang = Object.keys(starterCodeObj)[0];
            initialCode = starterCodeObj[firstLang];
          }
        }

        // Initialize CodeMirror with enhanced features
        const editor = CodeMirror(editorDiv, {
          value: initialCode,
          mode: languageModes[initialLang] || 'python',
          theme: 'monokai',
          lineNumbers: true,
          indentUnit: 4,
          indentWithTabs: false,
          smartIndent: true,
          autoCloseBrackets: true,
          matchBrackets: true,
          lineWrapping: true,
          styleActiveLine: true,
          foldGutter: true,
          gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
          scrollbarStyle: 'simple',
          extraKeys: {
            'Tab': function (cm) {
              if (cm.somethingSelected()) {
                cm.indentSelection('add');
              } else {
                cm.replaceSelection('    ', 'end'); // 4 spaces for Python
              }
            },
            'Shift-Tab': function (cm) {
              cm.indentSelection('subtract');
            },
            'Ctrl-/': function (cm) {
              // Toggle comment (simple implementation)
              const selection = cm.getSelection();
              const lines = selection.split('\n');
              const allCommented = lines.every(line => line.trim().startsWith('#') || line.trim() === '');
              const newLines = lines.map(line => {
                if (line.trim() === '') return line;
                if (allCommented) {
                  return line.replace(/^(\s*)#\s?/, '$1');
                } else {
                  const match = line.match(/^(\s*)/);
                  return (match ? match[1] : '') + '# ' + line.trim();
                }
              });
              cm.replaceSelection(newLines.join('\n'));
            },
            'Ctrl-S': function (cm) {
              // Prevent default save, but allow custom handling
              return false;
            },
            'Ctrl-F': function (cm) {
              // Find functionality
              return false; // Let browser handle it
            },
            'Enter': function (cm) {
              // Smart auto-indent on Enter - like modern IDEs
              const cursor = cm.getCursor();
              const line = cm.getLine(cursor.line);
              const indentMatch = line.match(/^(\s*)/);
              let indent = indentMatch ? indentMatch[1] : '';

              // Check if current line ends with colon (Python-style) or opening brace
              const trimmedLine = line.trim();
              if (trimmedLine.endsWith(':') || trimmedLine.endsWith('{')) {
                // Add extra indentation for blocks
                indent += '    '; // 4 spaces
              }

              // Insert newline with proper indentation
              cm.replaceSelection('\n' + indent);

              // Move cursor to end of inserted text
              cm.setCursor(cursor.line + 1, indent.length);
            },
            'Ctrl-Enter': function (cm) {
              // Quick run shortcut
              const runBtn = editorDiv.closest('.code-panel').querySelector('.run-code-btn');
              if (runBtn) runBtn.click();
            }
          }
        });

        // Store editor reference
        window.codeMirrorEditors[questionId] = editor;

        // Set initial value - ensure code is always visible
        if (!initialCode || initialCode.trim() === '') {
          // Set default starter code based on language
          const defaultCode = {
            'python': '# Write your code here\n',
            'java': '// Write your code here\n',
            'cpp': '// Write your code here\n',
            'c': '// Write your code here\n',
            'javascript': '// Write your code here\n'
          };
          initialCode = defaultCode[initialLang] || defaultCode['python'];
        }

        // Set the code in editor and textarea
        editor.setValue(initialCode);
        textarea.value = initialCode;

        // Ensure editor is focusable and clickable
        editorDiv.style.pointerEvents = 'auto';
        editorDiv.style.cursor = 'text';

        // Sync CodeMirror to textarea on change
        editor.on('change', function () {
          textarea.value = editor.getValue();
        });

        // Refresh editor to fix any rendering issues
        setTimeout(() => {
          editor.refresh();
          editor.focus();
        }, 200);

        // Update mode when language changes
        if (languageSelect) {
          languageSelect.addEventListener('change', function () {
            const newLang = this.value;
            const mode = languageModes[newLang] || 'python';
            editor.setOption('mode', mode);

            // Update code if switching languages
            const codingQ = codingQuestions.find(q => q.id == questionId && q.qtype === 'coding');
            if (codingQ && codingQ.starter_code) {
              // Parse starter_code if it's a JSON string
              let starterCodeObj = codingQ.starter_code;
              if (typeof starterCodeObj === 'string') {
                try {
                  starterCodeObj = JSON.parse(starterCodeObj);
                } catch (e) {
                  starterCodeObj = {};
                }
              }

              const starterCode = starterCodeObj[newLang] || '';
              const currentCode = editor.getValue();
              // Only update if editor is empty or has default/old starter code
              if (currentCode.trim() === '' || (starterCode && currentCode === starterCodeObj[Object.keys(starterCodeObj)[0]])) {
                editor.setValue(starterCode || '');
              }
            }
            // Hide test results when language changes
            document.getElementById('test_results_' + questionId).style.display = 'none';
          });
        }
      }
    }
  });

  // Handle Test Code button clicks
  document.querySelectorAll('.test-code-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
      const questionId = this.getAttribute('data-question-id');
      const codeTextarea = document.getElementById('code_' + questionId);
      const languageSelect = document.getElementById('language_' + questionId);
      const resultSpan = document.getElementById('test_result_' + questionId);
      const timeLimit = parseInt(this.getAttribute('data-time-limit')) || 2;
      const memoryLimit = parseInt(this.getAttribute('data-memory-limit')) || 256;

      // Get code from CodeMirror if available, otherwise from textarea
      let code;
      if (window.codeMirrorEditors && window.codeMirrorEditors[questionId]) {
        code = window.codeMirrorEditors[questionId].getValue();
        // Sync to textarea
        codeTextarea.value = code;
      } else {
        code = codeTextarea.value;
      }
      const language = languageSelect.value;

      if (!code.trim()) {
        resultSpan.innerHTML = '<span style="color: #f48771;">Please write some code first!</span>';
        return;
      }

      resultSpan.innerHTML = '<span style="color: #4ec9b0;">Testing...</span>';
      this.disabled = true;

      const testResultsPanel = document.getElementById('test_results_' + questionId);
      testResultsPanel.style.display = 'block';
      document.getElementById('test_details_' + questionId).innerHTML = '<div style="color: #858585;">Running tests...</div>';

      try {
        const testCases = testCasesMap[questionId] || [];
        const visibleTests = testCases.filter(tc => !tc.is_hidden).slice(0, 2); // Test with first 2 visible cases

        const response = await fetch('/api/run_test_cases', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code: code,
            language: language,
            test_cases: visibleTests,
            time_limit: timeLimit,
            memory_limit: memoryLimit
          })
        });

        // Check if response is OK and is JSON
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON but got: ${contentType}. Response: ${text.substring(0, 200)}`);
        }

        const data = await response.json();
        const testResultsPanel = document.getElementById('test_results_' + questionId);
        const testDetailsDiv = document.getElementById('test_details_' + questionId);

        // Show test results panel
        testResultsPanel.style.display = 'block';

        if (data.success && data.result) {
          const passed = data.result.passed;
          const total = data.result.total;
          const results = data.result.results || [];

          if (passed === total && total > 0) {
            resultSpan.innerHTML = `<span style="color: #4ec9b0;">‚úì Passed ${passed}/${total} test cases</span>`;
            resultSpan.style.color = '#4ec9b0';
          } else {
            resultSpan.innerHTML = `<span style="color: #f48771;">‚ö† Passed ${passed}/${total} test cases</span>`;
            resultSpan.style.color = '#f48771';
          }

          // Display detailed test results
          let detailsHTML = '<div style="font-size: 13px;">';
          results.forEach((test, idx) => {
            const status = test.is_correct ? '‚úì' : '‚úó';
            const color = test.is_correct ? '#4ec9b0' : '#f48771';
            detailsHTML += `<div style="margin-bottom: 10px; padding: 8px; background: #1e1e1e; border-radius: 4px; border-left: 3px solid ${color};">
            <div style="color: ${color}; font-weight: bold; margin-bottom: 5px;">Test Case ${idx + 1}: ${status} ${test.is_correct ? 'Passed' : 'Failed'}</div>
            ${!test.is_hidden ? `<div style="color: #858585; font-size: 12px;">Input: <code style="color: #ce9178;">${test.input}</code></div>` : ''}
            ${!test.is_hidden ? `<div style="color: #858585; font-size: 12px;">Expected: <code style="color: #4ec9b0;">${test.expected_output}</code></div>` : ''}
            ${test.actual_output ? `<div style="color: #858585; font-size: 12px;">Got: <code style="color: ${test.is_correct ? '#4ec9b0' : '#f48771'};">${test.actual_output}</code></div>` : ''}
            ${test.error ? `<div style="color: #f48771; font-size: 12px;">Error: ${test.error}</div>` : ''}
          </div>`;
          });
          detailsHTML += '</div>';
          testDetailsDiv.innerHTML = detailsHTML;
        } else {
          resultSpan.innerHTML = `<span style="color: #f48771;">Error: ${data.error || 'Execution failed'}</span>`;
          resultSpan.style.color = '#f48771';
          testDetailsDiv.innerHTML = `<div style="color: #f48771;">${data.error || 'Failed to execute code'}</div>`;
        }
      } catch (error) {
        resultSpan.innerHTML = `<span style="color: #f48771;">Error: ${error.message}</span>`;
        const testResultsPanel = document.getElementById('test_results_' + questionId);
        const testDetailsDiv = document.getElementById('test_details_' + questionId);
        if (testResultsPanel) testResultsPanel.style.display = 'block';
        if (testDetailsDiv) testDetailsDiv.innerHTML = `<div style="color: #f48771;">Error: ${error.message}</div>`;
      }

      this.disabled = false;
    });
  });

  // Before form submission, ensure code from CodeMirror editors is properly submitted
  const quizForm = document.getElementById('quizForm');
  const submitBtn = document.getElementById('submitBtn');

  if (quizForm) {
    quizForm.addEventListener('submit', function (e) {
      console.log('Form submit event triggered');

      // Sync all CodeMirror editors back to their textareas
      if (window.codeMirrorEditors) {
        Object.keys(window.codeMirrorEditors).forEach(questionId => {
          const editor = window.codeMirrorEditors[questionId];
          const textarea = document.getElementById('code_' + questionId);
          if (editor && textarea) {
            const code = editor.getValue();
            textarea.value = code;
            console.log(`Synced code for question ${questionId}, length: ${code.length}`);
          }
        });
      }

      // Disable submit button to prevent double submission
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      // Allow form to submit normally
      return true;
    });

    // Also handle submit button click directly
    if (submitBtn) {
      submitBtn.addEventListener('click', function (e) {
        console.log('Submit button clicked');
        // Sync CodeMirror before submit
        if (window.codeMirrorEditors) {
          Object.keys(window.codeMirrorEditors).forEach(questionId => {
            const editor = window.codeMirrorEditors[questionId];
            const textarea = document.getElementById('code_' + questionId);
            if (editor && textarea) {
              textarea.value = editor.getValue();
            }
          });
        }
      });
    }
  }

  // Question Navigation Logic - Make functions global
  window.currentQuestionIndex = 0;
  window.totalQuestions = {{ questions | length }};

  window.updateQuestionIndicator = function (index) {
    const indicator = document.getElementById('current-question-indicator');
    if (indicator) {
      indicator.textContent = `Question ${index + 1} of ${window.totalQuestions}`;
    }

    // Update question number buttons
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
      const btnIndex = parseInt(btn.getAttribute('data-question-index'));
      if (btnIndex === index) {
        btn.style.background = '#0078d4';
        btn.style.color = '#fff';
        btn.style.borderColor = '#0078d4';
      } else {
        btn.style.background = '#3e3e42';
        btn.style.color = '#d4d4d4';
        btn.style.borderColor = '#555';
      }
    });
  }

  window.updateNavigationButtons = function (index) {
    // Update Previous button visibility
    document.querySelectorAll('.prev-question-btn').forEach(btn => {
      const btnIndex = parseInt(btn.getAttribute('data-question-index'));
      if (btnIndex === index) {
        btn.style.display = index > 0 ? 'inline-block' : 'none';
      }
    });

    // Update Next button visibility
    document.querySelectorAll('.next-question-btn').forEach(btn => {
      const btnIndex = parseInt(btn.getAttribute('data-question-index'));
      if (btnIndex === index) {
        btn.style.display = index < window.totalQuestions - 1 ? 'inline-block' : 'none';
      }
    });
  }

  window.saveCurrentAnswer = function () {
    // Sync CodeMirror editors if any
    if (window.codeMirrorEditors) {
      Object.keys(window.codeMirrorEditors).forEach(questionId => {
        const editor = window.codeMirrorEditors[questionId];
        const textarea = document.getElementById('code_' + questionId);
        if (editor && textarea) {
          textarea.value = editor.getValue();
        }
      });
    }
    // Answers are automatically saved in form fields
  }

  window.showQuestion = function (index) {
    // Hide all questions
    document.querySelectorAll('.question-wrapper').forEach(wrapper => {
      wrapper.style.display = 'none';
    });

    // Show selected question
    const questionWrapper = document.querySelector(`.question-wrapper[data-question-index="${index}"]`);
    if (questionWrapper) {
      questionWrapper.style.display = 'block';
      window.currentQuestionIndex = index;
      window.updateQuestionIndicator(index);
      window.updateNavigationButtons(index);

      // Scroll to top of question
      questionWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // Initialize on page load
  window.updateQuestionIndicator(0);
  window.updateNavigationButtons(0);

  // Handle question number button clicks
  document.querySelectorAll('.question-nav-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const index = parseInt(this.getAttribute('data-question-index'));
      window.saveCurrentAnswer();
      window.showQuestion(index);
    });
  });

  // Handle Next button clicks
  document.querySelectorAll('.next-question-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const currentIndex = parseInt(this.getAttribute('data-question-index'));
      window.saveCurrentAnswer();
      if (currentIndex < window.totalQuestions - 1) {
        window.showQuestion(currentIndex + 1);
      }
    });
  });

  // Handle Previous button clicks
  document.querySelectorAll('.prev-question-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const currentIndex = parseInt(this.getAttribute('data-question-index'));
      window.saveCurrentAnswer();
      if (currentIndex > 0) {
        window.showQuestion(currentIndex - 1);
      }
    });
  });

  // Handle Final Submit Button (top right)
  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  if (finalSubmitBtn) {
    finalSubmitBtn.addEventListener('click', function () {
      // Set flag BEFORE showing confirmation dialog (which exits fullscreen)
      window.isSubmittingQuiz = true;

      if (confirm('Are you sure you want to submit the quiz? You cannot change your answers after submission.')) {
        window.saveCurrentAnswer();
        // Sync all CodeMirror editors
        if (window.codeMirrorEditors) {
          Object.keys(window.codeMirrorEditors).forEach(questionId => {
            const editor = window.codeMirrorEditors[questionId];
            const textarea = document.getElementById('code_' + questionId);
            if (editor && textarea) {
              textarea.value = editor.getValue();
            }
          });
        }
        // Submit the form
        document.getElementById('quizForm').submit();
      } else {
        // User cancelled - reset flag
        window.isSubmittingQuiz = false;
      }
    });
  }

  // Language change handler is now handled in CodeMirror initialization above

  // Fix reset button functionality
  document.querySelectorAll('.reset-code-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const questionId = this.getAttribute('data-question-id');
      const codeTextarea = document.getElementById('code_' + questionId);
      const languageSelect = document.getElementById('language_' + questionId);
      const codingQ = codingQuestions.find(q => q.id == questionId && q.qtype === 'coding');
      if (codingQ && codingQ.starter_code) {
        const lang = languageSelect.value;
        const starterCode = codingQ.starter_code[lang] || '';
        codeTextarea.value = starterCode;
        // Update CodeMirror if available
        if (window.codeMirrorEditors && window.codeMirrorEditors[questionId]) {
          window.codeMirrorEditors[questionId].setValue(starterCode);
        }
      }
      // Hide test results
      document.getElementById('test_results_' + questionId).style.display = 'none';
    });
  });
});
</script>

<style>
  /* Disable selection/copy - but allow in code editors and textareas */
  body {
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  /* Allow text selection in code editors and textareas */
  .CodeMirror,
  .CodeMirror *,
  .code-editor,
  textarea,
  input[type="text"],
  .answer-textarea {
    -webkit-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
    pointer-events: auto !important;
  }

  /* Ensure fullscreen gate and button are always clickable */
  #fs-gate {
    pointer-events: auto !important;
    z-index: 99999 !important;
  }

  #fs-gate * {
    pointer-events: auto !important;
  }

  #startQuizBtn {
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 100001 !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    -ms-user-select: none !important;
    position: relative !important;
  }

  #startQuizBtn:hover {
    opacity: 0.9;
    transform: scale(1.02);
    transition: all 0.2s ease;
  }

  #startQuizBtn:active {
    transform: scale(0.98);
  }

  /* Responsive design for coding questions */
  @media (max-width: 768px) {
    .coding-question-container {
      grid-template-columns: 1fr !important;
    }

    .problem-panel {
      max-height: 400px !important;
    }

    .code-panel {
      min-height: 400px !important;
    }
  }

  /* CodeMirror styling */
  .CodeMirror {
    height: 100% !important;
    min-height: 400px;
    font-size: 15px;
    line-height: 1.6;
    font-family: 'Consolas', 'Monaco', 'Courier New', 'Fira Code', monospace;
    background: #1e1e1e !important;
    color: #d4d4d4 !important;
    border-radius: 8px;
    overflow: hidden;
    position: relative !important;
    z-index: 1 !important;
    pointer-events: auto !important;
    cursor: text !important;
  }

  .CodeMirror-scroll {
    min-height: 400px;
    padding: 0 !important;
  }

  .CodeMirror-wrap .CodeMirror-scroll {
    overflow-x: auto !important;
    overflow-y: auto !important;
  }

  .CodeMirror-gutters {
    background: #252526 !important;
    border-right: 1px solid #3e3e42 !important;
    width: 60px !important;
    padding-right: 10px !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    z-index: 3 !important;
  }

  .CodeMirror-linenumber {
    color: #858585 !important;
    padding: 0 10px 0 0 !important;
    min-width: 50px !important;
    width: 50px !important;
    text-align: right !important;
    cursor: default !important;
    display: inline-block !important;
    box-sizing: border-box !important;
  }

  .CodeMirror-lines {
    padding-left: 70px !important;
    padding-right: 10px !important;
    padding-top: 10px !important;
    padding-bottom: 10px !important;
  }

  .CodeMirror-sizer {
    padding-left: 70px !important;
    margin-left: 0 !important;
  }

  .CodeMirror-cursor {
    border-left: 2px solid #fff !important;
    border-left-width: 2px !important;
  }

  .CodeMirror-selected {
    background: rgba(0, 120, 212, 0.3) !important;
  }

  .CodeMirror-focused .CodeMirror-selected {
    background: rgba(0, 120, 212, 0.4) !important;
  }

  .CodeMirror-activeline-background {
    background: rgba(255, 255, 255, 0.05) !important;
  }

  /* Code editor styling */
  .code-editor {
    tab-size: 2;
    -moz-tab-size: 2;
  }

  .code-editor:focus {
    outline: none;
    box-shadow: inset 0 0 0 1px #0078d4;
  }

  /* Improve code panel responsiveness */
  .code-panel {
    transition: all 0.3s ease;
  }

  .code-panel:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
</style>
{% endblock %}